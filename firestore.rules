rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated admin
    function isAdmin() {
      return request.auth != null;
    }
    
    // Clients collection
    match /clients/{clientId} {
      // Public can only create (during intake)
      allow create: if true;
      // Only admin can read/update/delete
      allow read, update, delete: if isAdmin();
    }
    
    // Pets collection
    match /pets/{petId} {
      // Public can only create (during intake)
      allow create: if true;
      // Only admin can read/update/delete
      allow read, update, delete: if isAdmin();
    }
    
    // Requests collection
    match /requests/{requestId} {
      // Public can only create (booking requests)
      allow create: if true;
      // Only admin can read/update/delete
      allow read, update, delete: if isAdmin();
    }
    
    // Visits collection
    match /visits/{visitId} {
      // Only admin can create/read/update/delete
      allow read, write: if isAdmin();
    }
    
    // Settings collection (single document)
    match /settings/config {
      // Public can read settings (for payment links)
      allow read: if true;
      // Only admin can write
      allow write: if isAdmin();
    }

    // Testimonials collection
    match /testimonials/{testimonialId} {
      // Public can read testimonials
      allow read: if true;
      // Public can create testimonials with a limited schema
      allow create: if
        request.resource.data.keys().hasOnly(['name', 'message', 'rating', 'createdAt']) &&
        request.resource.data.name is string &&
        request.resource.data.message is string &&
        request.resource.data.rating is int &&
        request.resource.data.rating >= 1 &&
        request.resource.data.rating <= 5 &&
        request.resource.data.name.size() >= 2 &&
        request.resource.data.name.size() <= 50 &&
        request.resource.data.message.size() >= 10 &&
        request.resource.data.message.size() <= 500 &&
        request.resource.data.createdAt == request.time;
      // Only admin can update/delete
      allow update, delete: if isAdmin();
    }

    // Mail collection for email notifications
    match /mail/{mailId} {
      // Public can create notification emails with a limited schema
      allow create: if
        request.resource.data.keys().hasOnly(['to', 'message']) &&
        request.resource.data.to is string &&
        request.resource.data.message.keys().hasOnly(['subject', 'text']) &&
        request.resource.data.message.subject is string &&
        request.resource.data.message.text is string;
      // Only admin can read/update/delete
      allow read, update, delete: if isAdmin();
    }
  }
}
